{% extends 'songs/base.html' %}
{% block title %}Add course{% endblock %}
{% load static %}

{% block head %}
    <script type="text/javascript" src="{% url 'songs:javascript-catalog' %}"></script>

    {{ courseForm.media }}

    <link rel="stylesheet" href="{% static "courses/course_styles.css" %}">

    <style media="screen">
        .selector select::-webkit-scrollbar {
            width: 0.4em;
        }
        .selector select::-webkit-scrollbar-thumb {
            background-color: rgba(0,0,0,1);
            border-radius: 10px;
        }
        .selector select::-webkit-scrollbar-track {
            background-color: white;
            border-radius: 10px;
        }
        .selector-available, .selector-chosen {
            width: 200px;
        }
        .selector h2 {
            font-size: 1.1em;
            color: white !important;
            background: rgba(255, 255, 255, 0.4) !important;
        }
        .selector select {
            width: inherit;
            height: 3.8em !important;
            color: white;
            background: rgba(255, 255, 255, 0.4);
        }
        .selector ul.selector-chooser {
            margin: 2.5em 5px 0 5px;
        }
        .selector .selector-filter, .selector .help-icon {
            display: none;
        }

        .default-theme {
            padding-top: 0.5em;
            padding-bottom: 0.2em;
            margin-bottom: 0.5em;
            position: relative;
        }

        .body-wrapper {
            background-color: rgba(255, 255, 255, 0.2);
        }

        .section-btn-up {
            position: absolute;
            top: 24px;
            right: 5px;
        }
        .section-btn-down {
            position: absolute;
            top: 75px;
            right: 5px;
        }
        .section-btn-remove {
            position: absolute;
            bottom: 16px;
            right: 5px;
        }
        {{ request.user.settings.course_theme.as_css | safe }}

    </style>
{% endblock %}

{% block breadcrumbs %}
    <li class="breadcrumb-item"><a href="{% url 'courses:all_courses' %}">Alle Kurs</a></li>
    {% if courseID %}
        <li class="breadcrumb-item"><a href="{% url 'courses:edit_course' courseID %}">Rediger Kurs</a></li>
    {% else %}
        <li class="breadcrumb-item"><a href="{% url 'courses:add_course' %}">Legg til Kurs</a></li>
    {% endif %}
{% endblock %}

{% block body %}

    <div class="body-wrapper rounded p-3">

    <h1>Rediger kurs:</h1>

    {{ courseForm.non_field_errors }}

    <form method="post">
        {% csrf_token %}

        <div id="courseForm">

            <div class="form-row">
                <div class="form-group col-md-4">
                    {{ courseForm.title.label_tag }}
                    {{ courseForm.title }}
                </div>
                <div class="form-group col-md-5">
                    {{ courseForm.place.label_tag }}
                    {{ courseForm.place }}
                </div>
                <div class="error">
                    {{ courseForm.title.errors }}
                    {{ courseForm.place.errors }}
                </div>
            </div>
            <div class="form-row">
                <div class="form-group col-md-2">
                    {{ courseForm.date.label_tag }}
                    {{ courseForm.date }}
                </div>
                <div class="form-group col-md-1">
                    {{ courseForm.start.label_tag }}
                    {{ courseForm.start }}
                </div>
                <div class="form-group col-md-1">
                    {{ courseForm.end.label_tag }}
                    {{ courseForm.end }}
                </div>
            </div>
            <div class="error">
                {{ courseForm.date.errors }}
                {{ courseForm.start.errors }}
                {{ courseForm.end.errors }}
            </div>
            <div class="form-row mb-1">
                <div class="form-group col-md-4">
                    {{ courseForm.lead.label_tag }}
                    {{ courseForm.lead }}
                    {{ courseForm.lead.errors }}
                </div>
                <div class="form-group col-md-4">
                    {{ courseForm.follow.label_tag }}
                    {{ courseForm.follow }}
                    {{ courseForm.follow.errors }}
                </div>
            </div>
            <div class="form-row">
                {{ courseForm.tags }}
            </div>
            <a class="btn btn-secondary btn-sm" target="_blank" href="{% url 'songs:add_tag' %}">Ny tag</a>
        </div>

        <br>

        <div id="dynamic-sections">

            <input id="sectionCount" type="hidden" readonly name="sectionCount" value="{{ sectionForms | length }}">

            {% for sectionForm in sectionForms %}

                <div id="section" class="jumbotron default-theme user-theme mt-3">

                    <input type="hidden" name="prefix" value="{{ sectionForm.prefix }}">

                    <div class="row">

                        <div class="col-10">

                            <div class="form-row">
                                <div class="form-group col-md">
                                    {{ sectionForm.title.label_tag }}
                                    {{ sectionForm.title }}
                                </div>
                                <div class="form-group col-md-2">
                                    {{ sectionForm.duration.label_tag }}
                                    {{ sectionForm.duration }}
                                </div>
                                <div class="form-group col-md">
                                    {{ sectionForm.song.label_tag }}
                                    <a class="btn btn-success text-light btn-sm" target="_blank" href="{% url 'songs:add_song' %}"><i class="lni-spotify-original"></i> Legg til</a>
                                    {{ sectionForm.song }}
                                </div>
                            </div>
                            <div class="bg-danger rounded">
                                {{ sectionForm.title.errors }}
                                {{ sectionForm.duration.errors }}
                                {{ sectionForm.song.errors }}
                            </div>
                            <div class="form-row">
                                <div class="form-group col-md">
                                    {{ sectionForm.description.label_tag }}
                                    {{ sectionForm.description }}
                                    {{ sectionForm.description.errors }}
                                </div>
                            </div>
                        </div>

                        <div class="col-2">
                            <button class="btn btn-dark section-btn-up" type="button" name="button">Opp</button>
                            <button class="btn btn-dark section-btn-down" type="button" name="button">Ned</button>
                            <button class="btn btn-dark section-btn-remove" type="button" name="button">Fjern</button>
                        </div>

                    </div>
                </div>
            {% endfor %}

        </div>

        <button class="btn btn-dark border border-warning" id="section-btn-add" type="button" name="button" >
            <img src="https://img.icons8.com/material-rounded/25/FFAA00/plus-math.png">
            Legg til ny del
        </button>

        <div class="form-row mt-4">
            <div class="form-group col-md-6">
                {{ courseForm.comments.label_tag }}
                {{ courseForm.comments }}
                {{ courseForm.comments.errors }}
            </div>
        </div>

        <div class="row">
            <div class="col-8">
                <button class="btn btn-block btn-dark" type="submit">Lagre</button>
            </div>
            {% if courseID %}

                <!-- Delete Course (button) -->
                <div class="col">
                    <button type="button" class="btn btn-block btn-danger" data-toggle="modal" data-target="#delete-course">Slett</button>
                </div>

            {% endif %}
        </div>
    </form>

    <!-- Delete Course (modal) -->
    <div class="modal fade text-dark" id="delete-course" tabindex="-1" role="dialog">
        <div class="modal-dialog" role="document">
            <div class="modal-content">

                <div class="modal-header">
                    <h5 class="modal-title">Er du helt sikker p√• at du vil slette kurset?</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label_tag="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>

                <div class="modal-body"><p>Du vil miste all data!</p></div>

                <div class="modal-footer">
                    <!-- Delete Course confirmed (button) -->
                    {% if courseID %}
                        <form id="form_delete" action="{% url 'courses:delete_course' courseID %}" method="post">
                            {% csrf_token %}
                            <button class="btn btn-danger" type="submit" name="button">Slett kurs</button>
                        </form>
                    {% endif %}

                    <!-- Cancel (button) -->
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Avbryt</button>
                </div>
            </div>
        </div>
    </div> <!-- End: Delete Course (modal) -->

        <!-- TEMPLATE -->
        <div id="sectionFormTemplate" class="d-none">

            <div id="section" class="jumbotron default-theme user-theme mt-3">

                <input type="hidden" name="prefix" value="template">

                <div class="row">

                    <div class="col-10">

                        <div class="form-row">
                            <div class="form-group col-md">
                                {{ sectionFormTemplate.title.label_tag }}
                                {{ sectionFormTemplate.title }}
                            </div>
                            <div class="form-group col-md-2">
                                {{ sectionFormTemplate.duration.label_tag }}
                                {{ sectionFormTemplate.duration }}
                            </div>
                            <div class="form-group col-md">
                                {{ sectionFormTemplate.song.label_tag }}
                                <a class="btn btn-success btn-sm" target="_blank" href="{% url 'songs:add_song' %}"><i class="lni-spotify-original"></i> Legg til</a>
                                {{ sectionFormTemplate.song }}
                            </div>
                        </div>
                        <div class="bg-danger rounded">
                            {{ sectionFormTemplate.title.errors }}
                            {{ sectionFormTemplate.duration.errors }}
                            {{ sectionFormTemplate.song.errors }}
                        </div>
                        <div class="form-row">
                            <div class="form-group col-md">
                                {{ sectionFormTemplate.description.label_tag }}
                                {{ sectionFormTemplate.description }}
                                {{ sectionFormTemplate.description.errors }}
                            </div>
                        </div>
                    </div>

                    <div class="col-2">
                        <button class="btn btn-dark section-btn-up" type="button" name="button">Opp</button>
                        <button class="btn btn-dark section-btn-down" type="button" name="button">Ned</button>
                        <button class="btn btn-dark section-btn-remove" type="button" name="button">Fjern</button>
                    </div>

                </div>
            </div>
        </div>

    </div> <!-- END: body-wrapper -->

{% endblock %}

{% block script %}
    <script type="text/javascript">

        var tinymceConfig = {
            selector: "textarea.tinymce",
            plugins: 'advlist autoresize autosave codesample emoticons help lists print searchreplace tabfocus textpattern',
            menubar: 'file edit insert view format tools table help',
            toolbar: 'undo redo | fontselect | fontsizeselect | bold italic underline | forecolor | backcolor | removeformat | numlist bullist',
            min_height: 50,
            max_height: 600,
            toolbar_sticky: false,
            autosave_ask_before_unload: true,
            autosave_interval: "30s",
            autosave_prefix: "{path}{query}-{id}-",
            autosave_restore_when_empty: false,
            autosave_retention: "2m",
            tabfocus_elements: ":prev,:next",
            toolbar_items_size: "small",
        }

        var sectionFormTemplate = $("#sectionFormTemplate").html();
        $("#sectionFormTemplate").remove();

        tinymce.init(tinymceConfig);

        $(document).ready(function() {

            function sleep(time) {
                return new Promise((resolve) => setTimeout(resolve, time));
            }

            $('body').on("click", "#section-btn-add", function() {
                $("#sectionCount").val( +$("#sectionCount").val() + 1)
                $("#dynamic-sections").append( sectionFormTemplate.replace(/template/g, $("#sectionCount").val()) )
                sleep(10).then(() => tinymce.init(tinymceConfig) );
            })

            $('body').on("click", ".section-btn-remove", function() {
                tinymce.remove();
                var s = $(this).closest("#section");
                $("#sectionCount").val( +$("#sectionCount").val() - 1);
                s.remove();
                sleep(10).then(() => tinymce.init(tinymceConfig) );
            });

            $('body').on("click", ".section-btn-up", function() {
                tinymce.remove();
                var s = $(this).closest("#section");
                s.insertBefore( s.prev() );
                sleep(10).then(() => tinymce.init(tinymceConfig) );
            });

            $('body').on("click", ".section-btn-down", function() {
                tinymce.remove();
                var s = $(this).closest("#section");
                s.insertAfter( s.next() );
                sleep(10).then(() => tinymce.init(tinymceConfig) );
            });

        })
    </script>
{% endblock script %}
